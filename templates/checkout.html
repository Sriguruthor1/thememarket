{% extends 'base.html' %}
{% load static %}

{% block title %}Secure Checkout - ThemeMarket{% endblock %}

{% block extra_css %}
<style>
    .checkout-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 2rem;
    }
    .checkout-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 2rem;
        color: #1e293b;
    }
    .checkout-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 3rem;
    }
    .checkout-form {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    .form-section {
        margin-bottom: 2rem;
    }
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #1e293b;
    }
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .form-group {
        margin-bottom: 1rem;
    }
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #374151;
    }
    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }
    .form-input:focus {
        outline: none;
        border-color: #5c2dd5;
        box-shadow: 0 0 0 3px rgba(92, 45, 213, 0.1);
    }
    .phone-input {
        display: flex;
        gap: 0.5rem;
    }
    .country-code {
        width: 80px;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background: white;
    }
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    .continue-btn {
        width: 100%;
        background: #4ade80;
        color: white;
        padding: 1rem;
        border-radius: 8px;
        border: none;
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
        margin-top: 1rem;
    }
    .order-summary {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        height: fit-content;
    }
    .summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #f1f5f9;
    }
    .summary-title {
        font-size: 1.25rem;
        font-weight: 700;
    }
    .item-count {
        color: #64748b;
        font-size: 0.9rem;
    }
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f8fafc;
    }
    .summary-item:last-child {
        border-bottom: none;
    }
    .item-name {
        color: #64748b;
    }
    .item-price {
        font-weight: 600;
    }
    .total-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid #f1f5f9;
    }
    .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .total-discount {
        color: #4ade80;
        font-weight: 600;
    }
    .final-total {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
    }
    .secure-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
        color: #64748b;
        font-size: 0.9rem;
    }
    @media (max-width: 768px) {
        .checkout-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .form-row {
            grid-template-columns: 1fr;
        }
        .phone-input {
            flex-direction: column;
        }
        .country-code {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="checkout-container">
    <h1 class="checkout-title">Secure Checkout</h1>
    
    <div class="checkout-grid">
        <div class="checkout-form">
            <form>
                <div class="form-section">
                    <h2 class="section-title">Contact Details</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <div class="phone-input">
                            <select class="country-code">
                                <option value="+91">+91</option>
                                <option value="+1">+1</option>
                                <option value="+44">+44</option>
                            </select>
                            <input type="tel" class="form-input" style="flex: 1;" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="section-title">Shipping Details</h2>
                    <div class="form-group">
                        <label class="form-label">Flat/House no.</label>
                        <input type="text" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">City</label>
                            <input type="text" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">State</label>
                            <input type="text" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Postal Code</label>
                            <input type="text" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Famous Landmark</label>
                            <input type="text" class="form-input">
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="sameAddress">
                        <label for="sameAddress">My shipping and Billing address are the same</label>
                    </div>
                </div>

                <button type="button" class="continue-btn" onclick="initiateRazorpayPayment()">Continue to Payment</button>
            </form>
        </div>

        <div class="order-summary">
            <div class="summary-header">
                <h3 class="summary-title">Order Summary</h3>
                <span class="item-count" id="itemCount">0 items</span>
            </div>

            <div id="orderItems">
                <!-- Dynamic cart items will be loaded here -->
            </div>

            <div class="total-section">
                <div class="total-row">
                    <span class="total-discount">Total discount</span>
                    <span class="total-discount" id="totalDiscount">₹0</span>
                </div>
                <div class="total-row">
                    <span>Handling Fee</span>
                    <span>₹0</span>
                </div>
                <div class="total-row">
                    <span class="final-total">Total</span>
                    <span class="final-total" id="finalTotal">₹0</span>
                </div>
            </div>

            <div class="secure-badge">
                <i class="fas fa-lock"></i>
                <span>Secure Checkout</span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadCheckoutItems();
});

function loadCheckoutItems() {
    const cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
    const orderItems = document.getElementById('orderItems');
    const itemCount = document.getElementById('itemCount');
    const totalDiscount = document.getElementById('totalDiscount');
    const finalTotal = document.getElementById('finalTotal');
    
    if (cartItems.length === 0) {
        orderItems.innerHTML = '<div class="summary-item"><span class="item-name">No items in cart</span><span class="item-price">₹0</span></div>';
        itemCount.textContent = '0 items';
        totalDiscount.textContent = '₹0';
        finalTotal.textContent = '₹0';
        return;
    }
    
    let total = 0;
    orderItems.innerHTML = '';
    
    cartItems.forEach(item => {
        const price = parseFloat(item.price.replace('₹', '').replace(',', ''));
        total += price;
        
        orderItems.innerHTML += `
            <div class="summary-item">
                <span class="item-name">${item.title}</span>
                <span class="item-price">${item.price}</span>
            </div>
        `;
    });
    
    const discount = Math.floor(total * 0.05);
    const finalAmount = total - discount;
    
    itemCount.textContent = `${cartItems.length} item${cartItems.length > 1 ? 's' : ''}`;
    totalDiscount.textContent = `₹${discount.toLocaleString('en-IN')}`;
    finalTotal.textContent = `₹${finalAmount.toLocaleString('en-IN')}`;
}
</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
function completePayment() {
    const cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
    const user = JSON.parse(localStorage.getItem('currentUser'));
    
    if (cartItems.length > 0 && user) {
        const order = {
            id: Date.now(),
            date: new Date().toLocaleDateString(),
            items: cartItems,
            total: cartItems.reduce((sum, item) => sum + parseFloat(item.price.replace('₹', '').replace(',', '')), 0),
            status: 'Completed'
        };
        
        const userOrders = JSON.parse(localStorage.getItem(`orders_${user.email}`) || '[]');
        userOrders.push(order);
        localStorage.setItem(`orders_${user.email}`, JSON.stringify(userOrders));
        localStorage.removeItem('cartItems');
    }
}

function initiateRazorpayPayment() {
    const cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
    if (cartItems.length === 0) {
        alert('No items in cart');
        return;
    }
    
    const total = cartItems.reduce((sum, item) => sum + parseFloat(item.price.replace('₹', '').replace(',', '')), 0);
    const discount = Math.floor(total * 0.05);
    const finalAmount = total - discount;
    
    const options = {
        "key": "rzp_test_RbxlYBHo3dkp9y",
        "amount": finalAmount * 100,
        "currency": "INR",
        "name": "ThemeMarket",
        "description": `Purchase of ${cartItems.length} item(s)`,
        "handler": function (response){
            try {
                completePayment();
                alert('Payment successful! Order placed. Payment ID: ' + response.razorpay_payment_id);
                setTimeout(function() {
                    window.top.location.href = window.location.origin;
                }, 1000);
            } catch (error) {
                alert('Order processing failed. Please contact support.');
            }
        },
        "prefill": {
            "name": document.querySelector('input[type="text"]').value,
            "email": document.querySelector('input[type="email"]').value,
            "contact": document.querySelector('input[type="tel"]').value
        },
        "theme": {
            "color": "#5c2dd5"
        },
        "modal": {
            "ondismiss": function(){
                alert('Payment cancelled');
            },
            "escape": false,
            "backdropclose": false
        },
        "retry": {
            "enabled": true,
            "max_count": 3
        }
    };
    
    const rzp1 = new Razorpay(options);
    
    rzp1.on('payment.failed', function (response){
        alert('Payment failed! Error: ' + response.error.description + '. Please try again.');
        console.error('Payment failed:', response.error);
    });
    
    rzp1.open();
}
</script>
{% endblock %}